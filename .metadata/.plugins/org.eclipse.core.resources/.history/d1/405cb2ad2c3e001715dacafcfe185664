package expresswaysimulation.init;

import java.util.Random;

import expresswaysimulation.agents.Auto;
import expresswaysimulation.agents.Gate;
import repast.simphony.context.Context;
import repast.simphony.context.space.continuous.ContinuousSpaceFactory;
import repast.simphony.context.space.continuous.ContinuousSpaceFactoryFinder;
import repast.simphony.context.space.grid.GridFactory;
import repast.simphony.context.space.grid.GridFactoryFinder;
import repast.simphony.dataLoader.ContextBuilder;
import repast.simphony.space.continuous.ContinuousSpace;
import repast.simphony.space.continuous.SimpleCartesianAdder;
import repast.simphony.space.grid.Grid;
import repast.simphony.space.grid.GridBuilderParameters;
import repast.simphony.space.grid.SimpleGridAdder;
import repast.simphony.space.grid.WrapAroundBorders;

public class ExpresswaySimulationBuilder implements ContextBuilder<Object> {
	

	@Override
	public Context build(Context<Object> context) {
		context.setId ("ExpresswaySimulation");
		
		ContinuousSpaceFactory spaceFactory = ContinuousSpaceFactoryFinder.createContinuousSpaceFactory (null);
		ContinuousSpace<Object> space = spaceFactory.createContinuousSpace("space", context, 
		        new SimpleCartesianAdder<Object>(), new repast.simphony.space.continuous.WrapAroundBorders(), 50 , 50);
		
		GridFactory gridFactory = GridFactoryFinder.createGridFactory(null);
		Grid<Object> grid = gridFactory.createGrid("grid", context,
                new GridBuilderParameters<Object>(new WrapAroundBorders(),
                        new SimpleGridAdder<Object>(), true, 50, 50));
		
		// Cars initialization
		for (int i = 0; i < 20; ++i) {
		    Auto auto = new Auto(space, grid);
		    context.add(auto);
		    
		    Random rndX = new Random();
		    boolean lane = rndX.nextBoolean();
		    int posX = lane ? 33 : 23;
		    
		    Random rndY = new Random();
		    int posY = rndY.nextInt(40);		   
		    
		    grid.moveTo(auto, posX, posY);
		    space.moveTo(auto, posX, posY);
		}
		
		// Gates initialization
		for (int i = 0; i < 4; ++i) {
		    Gate gate = new Gate(space, grid);
		    context.add(gate);
		    
		    grid.moveTo(gate, 5 + 10 * i, 45);
		    space.moveTo(gate, 5 + 10 * i, 45);
		}
		
		return context ;
	}

}
